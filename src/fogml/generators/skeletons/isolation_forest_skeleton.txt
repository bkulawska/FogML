// TODO: extract some common code from generator here